/*
 * AGTree v3.0.0-alpha.1 (build date: Tue, 12 Nov 2024 16:11:58 GMT)
 * (c) 2024 Adguard Software Ltd.
 * Released under the MIT license
 * https://github.com/AdguardTeam/tsurlfilter/tree/master/packages/agtree#readme
 */
import { AdblockSyntax } from '../../utils/adblockers.mjs';
import { DomainListSerializer } from '../misc/domain-list-serializer.mjs';
import { NULL } from '../../utils/constants.mjs';
import { CosmeticRuleType } from '../../nodes/index.mjs';
import { AbpSnippetInjectionBodySerializer } from './body/abp-snippet-injection-body-serializer.mjs';
import { UboScriptletInjectionBodySerializer } from './body/ubo-scriptlet-injection-body-serializer.mjs';
import { AdgScriptletInjectionBodySerializer } from './body/adg-scriptlet-injection-body-serializer.mjs';
import { ValueSerializer } from '../misc/value-serializer.mjs';
import { isUndefined } from '../../utils/type-guards.mjs';
import { BaseSerializer } from '../base-serializer.mjs';
import { ElementHidingBodySerializer } from './element-hiding-body-serializer.mjs';
import { CssInjectionBodySerializer } from './css-injection-body-serializer.mjs';
import { ModifierListSerializer } from '../misc/modifier-list-serializer.mjs';
import { CosmeticRuleMarshallingMap, COSMETIC_RULE_SEPARATOR_SERIALIZATION_MAP } from '../../marshalling-utils/cosmetic/cosmetic-rule-common.mjs';
import { BinaryTypeMarshallingMap } from '../../marshalling-utils/misc/binary-type-common.mjs';
import { getSyntaxSerializationMap } from '../../marshalling-utils/syntax-serialization-map.mjs';

/**
 * `CosmeticRuleParser` is responsible for parsing cosmetic rules.
 *
 * Where possible, it automatically detects the difference between supported syntaxes:
 *  - AdGuard
 *  - uBlock Origin
 *  - Adblock Plus
 *
 * If the syntax is common / cannot be determined, the parser gives `Common` syntax.
 *
 * Please note that syntactically correct rules are parsed even if they are not actually
 * compatible with the given adblocker. This is a completely natural behavior, meaningful
 * checking of compatibility is not done at the parser level.
 */
// TODO: Make raw body parsing optional
// TODO: Split into smaller sections
class CosmeticRuleSerializer extends BaseSerializer {
    /**
     * Serializes a cosmetic rule node to binary format.
     *
     * @param node Node to serialize.
     * @param buffer ByteBuffer for writing binary data.
     */
    // TODO: add support for raws, if ever needed
    static serialize(node, buffer) {
        // specific properties
        switch (node.type) {
            case CosmeticRuleType.ElementHidingRule:
                // rule type
                buffer.writeUint8(BinaryTypeMarshallingMap.ElementHidingRule);
                // syntax
                buffer.writeUint8(getSyntaxSerializationMap().get(node.syntax) ?? 0);
                // rule body
                ElementHidingBodySerializer.serialize(node.body, buffer);
                break;
            case CosmeticRuleType.CssInjectionRule:
                // rule type
                buffer.writeUint8(BinaryTypeMarshallingMap.CssInjectionRule);
                // syntax
                buffer.writeUint8(getSyntaxSerializationMap().get(node.syntax) ?? 0);
                // rule body
                CssInjectionBodySerializer.serialize(node.body, buffer);
                break;
            case CosmeticRuleType.JsInjectionRule:
                // rule type
                buffer.writeUint8(BinaryTypeMarshallingMap.JsInjectionRule);
                // syntax
                buffer.writeUint8(getSyntaxSerializationMap().get(node.syntax) ?? 0);
                // rule body
                ValueSerializer.serialize(node.body, buffer);
                break;
            case CosmeticRuleType.HtmlFilteringRule:
                // rule type
                buffer.writeUint8(BinaryTypeMarshallingMap.HtmlFilteringRule);
                // syntax
                buffer.writeUint8(getSyntaxSerializationMap().get(node.syntax) ?? 0);
                // rule body
                ValueSerializer.serialize(node.body, buffer);
                break;
            case CosmeticRuleType.ScriptletInjectionRule:
                // rule type
                buffer.writeUint8(BinaryTypeMarshallingMap.ScriptletInjectionRule);
                // syntax
                buffer.writeUint8(getSyntaxSerializationMap().get(node.syntax) ?? 0);
                // rule body
                switch (node.syntax) {
                    case AdblockSyntax.Adg:
                        AdgScriptletInjectionBodySerializer.serialize(node.body, buffer);
                        break;
                    case AdblockSyntax.Abp:
                        AbpSnippetInjectionBodySerializer.serialize(node.body, buffer);
                        break;
                    case AdblockSyntax.Ubo:
                        UboScriptletInjectionBodySerializer.serialize(node.body, buffer);
                        break;
                    default:
                        throw new Error('Scriptlet rule should have an explicit syntax');
                }
                break;
            default:
                throw new Error('Unknown cosmetic rule type');
        }
        // common properties
        buffer.writeUint8(CosmeticRuleMarshallingMap.Exception);
        buffer.writeUint8(node.exception ? 1 : 0);
        buffer.writeUint8(CosmeticRuleMarshallingMap.Separator);
        ValueSerializer.serialize(node.separator, buffer, COSMETIC_RULE_SEPARATOR_SERIALIZATION_MAP);
        if (node.modifiers) {
            buffer.writeUint8(CosmeticRuleMarshallingMap.Modifiers);
            ModifierListSerializer.serialize(node.modifiers, buffer);
        }
        buffer.writeUint8(CosmeticRuleMarshallingMap.Domains);
        DomainListSerializer.serialize(node.domains, buffer);
        if (!isUndefined(node.start)) {
            buffer.writeUint8(CosmeticRuleMarshallingMap.Start);
            buffer.writeUint32(node.start);
        }
        if (!isUndefined(node.end)) {
            buffer.writeUint8(CosmeticRuleMarshallingMap.End);
            buffer.writeUint32(node.end);
        }
        buffer.writeUint8(NULL);
    }
}

export { CosmeticRuleSerializer };
