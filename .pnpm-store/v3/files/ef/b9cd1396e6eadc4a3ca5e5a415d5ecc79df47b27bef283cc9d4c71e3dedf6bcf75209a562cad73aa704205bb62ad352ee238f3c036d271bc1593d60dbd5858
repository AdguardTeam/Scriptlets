/*
 * AGTree v3.0.0-alpha.1 (build date: Tue, 12 Nov 2024 16:11:58 GMT)
 * (c) 2024 Adguard Software Ltd.
 * Released under the MIT license
 * https://github.com/AdguardTeam/tsurlfilter/tree/master/packages/agtree#readme
 */
import { UINT8_MAX, NULL } from '../../../utils/constants.mjs';
import { ParameterListSerializer } from '../../misc/parameter-list-serializer.mjs';
import { isUndefined } from '../../../utils/type-guards.mjs';
import { BaseSerializer } from '../../base-serializer.mjs';
import { AbpSnippetBodyMarshallingMap } from '../../../marshalling-utils/cosmetic/body/abp-snippet-injection-body-common.mjs';
import { BinaryTypeMarshallingMap } from '../../../marshalling-utils/misc/binary-type-common.mjs';

class ScriptletBodySerializer extends BaseSerializer {
    /**
     * Serializes a hint rule node to binary format.
     *
     * @param node Node to serialize.
     * @param buffer ByteBuffer for writing binary data.
     * @param frequentScriptletArgs Map of frequently used scriptlet names / arguments
     * and their serialization index (optional).
     */
    static serialize = (node, buffer, frequentScriptletArgs) => {
        buffer.writeUint8(BinaryTypeMarshallingMap.ScriptletInjectionRuleBodyNode);
        const { length } = node.children;
        buffer.writeUint8(AbpSnippetBodyMarshallingMap.Children);
        // note: we store the count, because re-construction of the array is faster if we know the length
        if (length > UINT8_MAX) {
            throw new Error(`Too many scriptlet children: ${length}, the limit is ${UINT8_MAX}`);
        }
        buffer.writeUint8(length);
        for (let i = 0; i < length; i += 1) {
            ParameterListSerializer.serialize(node.children[i], buffer, frequentScriptletArgs);
        }
        if (!isUndefined(node.start)) {
            buffer.writeUint8(AbpSnippetBodyMarshallingMap.Start);
            buffer.writeUint32(node.start);
        }
        if (!isUndefined(node.end)) {
            buffer.writeUint8(AbpSnippetBodyMarshallingMap.End);
            buffer.writeUint32(node.end);
        }
        buffer.writeUint8(NULL);
    };
}

export { ScriptletBodySerializer };
